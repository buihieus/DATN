const { GoogleGenerativeAI } = require('@google/generative-ai');
const { ObjectId } = require('mongoose').Types;

const genAI = new GoogleGenerativeAI(process.env.GOOGLE_API_KEY);
const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash' });

const modelPost = require('../../models/post.model');

async function askQuestion(question) {
    try {
        // Lấy một số bài đăng gần đây để Gemini tham khảo
        const recentPosts = await modelPost.find({}).sort({ createdAt: -1 }).limit(10);
        const postDataPreview = recentPosts.map((post) => `ID: ${post._id}, Tiêu đề: ${post.title}, Giá: ${post.price}, Địa điểm: ${post.location}`).join('\n');

        // Prompt mới để hướng dẫn Gemini trả lời và trả về dữ liệu phòng trọ nếu cần
        const prompt = `
        Bạn là một trợ lý chuyên nghiệp hỗ trợ tìm phòng trọ. Nhiệm vụ của bạn là trả lời các câu hỏi của người dùng một cách tự nhiên và thân thiện.

        Dưới đây là một số bài đăng phòng trọ mới nhất để bạn tham khảo:
        ${postDataPreview}

        Nếu người dùng yêu cầu tìm phòng trọ, hãy trả lời theo định dạng sau:
        __SHOW_ROOMS__:{"message": "Dưới đây là một số phòng trọ phù hợp với yêu cầu của bạn:", "roomIds": ["id1", "id2", ...]}
        Trong đó, "roomIds" là mảng ID của các bài đăng phù hợp nhất với yêu cầu của người dùng dựa trên thông tin bạn có. Nếu không tìm được bài đăng nào phù hợp, hãy trả lời tự nhiên.

        Nếu người dùng không yêu cầu tìm phòng trọ, hãy trả lời một cách tự nhiên và thân thiện như bình thường.

        Câu hỏi của khách hàng: ${question}
        `;

        const result = await model.generateContent(prompt);
        let answer = result.response.text();

        // Kiểm tra xem Gemini có yêu cầu hiển thị danh sách phòng trọ không
        const showRoomsPrefix = "__SHOW_ROOMS__:";
        if (answer.startsWith(showRoomsPrefix)) {
            try {
                // Trích xuất và parse JSON chứa thông tin phòng trọ
                const jsonString = answer.substring(showRoomsPrefix.length);
                const showRoomsData = JSON.parse(jsonString);

                // Lấy danh sách ID phòng trọ từ dữ liệu trả về
                const roomIds = showRoomsData.roomIds || [];

                // Truy vấn chi tiết các bài đăng dựa trên ID
                // Chuyển đổi chuỗi ID sang ObjectId để tìm kiếm trong MongoDB
                const roomObjectIds = roomIds.map(id => new ObjectId(id));
                const rooms = await modelPost.find({ '_id': { $in: roomObjectIds } });

                // Trả về một đối tượng đặc biệt để phía client xử lý
                return {
                    type: 'SHOW_ROOMS',
                    message: showRoomsData.message,
                    rooms: rooms
                };
            } catch (parseError) {
                console.error("Lỗi khi parse dữ liệu phòng trọ từ Gemini:", parseError);
                // Nếu parse lỗi, trả về câu trả lời gốc
                return answer;
            }
        } else {
            // Trả về câu trả lời thông thường nếu không yêu cầu hiển thị danh sách
            return answer;
        }
    } catch (error) {
        console.error("Lỗi trong hàm askQuestion:", error);
        return "Xin lỗi, tôi đang gặp sự cố. Vui lòng thử lại sau.";
    }
}

module.exports = { askQuestion };
